<!DOCTYPE html>
<html>

<head>
    <title>Crab Finder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<style>
    html,
    body {
        font-family: Tahoma;
        font-size: 16px;
        text-align: center;
        scroll-behavior: smooth;
    }

    .button {
        border-radius: 8px;
        border: none;
        background-color: #56A5E1;
        color: white;
        font-family: Tahoma;
        font-size: 13px;
        text-align: center;
        padding: 10px 15px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #438cc3;
    }

    .nav {
        border: 1px solid #ccc;
        border-width: 1px 0;
        list-style: none;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    .nav li {
        display: inline;
    }

    .nav a {
        display: inline-block;
        padding: 10px;
    }

    table {
        border-collapse: collapse;
        width: 50%;
        margin-left: auto;
        margin-right: auto;
        table-layout: fixed;
    }

    td,
    th {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #ddd;
    }

    th {
        padding-top: 12px;
        padding-bottom: 12px;
        background-color: #04AA6D;
        color: white;
    }
</style>

<body onload="checkSettings();">
    <ul class="nav">
        <li><a href="https://crabada-resources.github.io/looting_statistics/">Revenue statistics</a></li>
        <li><a href="https://crabada-resources.github.io/should_i_buy/">Should I buy this crab?</a></li>
        <li><a href="https://crabada-resources.github.io/breeding_calculator/">Breeding calculator</a></li>
    </ul>

    <div id="header">
        <h2>Crab Finder</h2>
        </br>
        <form id="crabs_settings" onsubmit="return false">
            <input type="checkbox" id="pure" name="pure" checked>
            <label for="pure">Pure</label><br>
            <input type="checkbox" id="pure_eggs" name="pure_eggs">
            <label for="pure_eggs">Pure Eggs</label><br>
            <input type="checkbox" id="legendary" name="legendary">
            <label for="legendary">Legendary</label><br>
            <input type="checkbox" id="highbp" name="highbp">
            <label for="highbp">High BP (220+)</label><br>
            <input type="checkbox" id="highmp" name="highmp">
            <label for="highmp">High MP (77+)</label><br>
            <input type="checkbox" id="c56" name="c56">
            <label for="c56">5/6 and 6/6 non-pure</label><br>
            Max price (optional): &nbsp;&nbsp;<input type="number" id="price" step="1" style="width: 10em" /><br>
            Max breed (optional): &nbsp;&nbsp;<input type="number" id="breed" step="1" style="width: 10em" /><br><br>

            <button id="calculateBtn" class="button" onclick="calculate()">Find crabs!</button>
        </form>

        <div id="results" style="display: none">
            <h3> Results </h3>
            <p id="loading">Loading...</p>
            <div id="resuls_text"></div>
            <br>
        </div>
    </div>

</body>
<script type="text/javascript">
    function checkSettings() {
        let pure = document.getElementById("pure");
        let pure_eggs = document.getElementById("pure_eggs");
        let legendary = document.getElementById("legendary");
        let highbp = document.getElementById("highbp");
        let highmp = document.getElementById("highmp");
        let c56 = document.getElementById("c56");
        let price = document.getElementById("price");
        let breed = document.getElementById("breed");


        if (localStorage.getItem("pure") != null) {
            pure.setAttribute("checked", localStorage.getItem("pure"));
        }

        if (localStorage.getItem("pure_eggs") != null) {
            pure_eggs.setAttribute("checked", localStorage.getItem("pure_eggs"));
        }

        if (localStorage.getItem("legendary") != null) {
            legendary.setAttribute("checked", localStorage.getItem("legendary"));
        }
        if (localStorage.getItem("highbp") != null) {
            highbp.setAttribute("checked", localStorage.getItem("highbp"));
        }
        if (localStorage.getItem("highmp") != null) {
            highmp.setAttribute("checked", localStorage.getItem("highmp"));
        }
        if (localStorage.getItem("c56") != null) {
            c56.setAttribute("checked", localStorage.getItem("c56"));
        }
        if (localStorage.getItem("price") != null) {
            price.setAttribute("value", localStorage.getItem("price"));
        }
        if (localStorage.getItem("breed") != null) {
            breed.setAttribute("value", localStorage.getItem("breed"));
        }

    }

    const dec2hex = str => { // .toString(16) only works up to 2^53
        var dec = str.toString().split(''), sum = [], hex = [], i, s
        while (dec.length) {
            s = 1 * dec.shift()
            for (i = 0; s || i < sum.length; i++) {
                s += (sum[i] || 0) * 10
                sum[i] = s % 16
                s = (s - sum[i]) / 16
            }
        }
        while (sum.length) {
            hex.push(sum.pop().toString(16))
        }
        return hex.join('')
    }

    const lookup = value => {
        if (value <= 8) {
            return 'SURGE'
        }
        else if (value < 24) {
            return 'SUNKEN'
        }
        else if (value < 39) {
            return 'PRIME'
        }
        else if (value < 54) {
            return 'BULK'
        }
        else if (value < 69) {
            return 'CRABOID'
        }
        else if (value < 84) {
            return 'RUINED'
        }
        else if (value < 99) {
            return 'GEM'
        }
        else if (value < 114) {
            return 'ORGANIC'
        }
        else {
            console.log(value, `ERROR`)
        }
    }

    const countAlleles = (dna, className) => {
        hexString = dec2hex(dna);
        dnafixed = `0${hexString}`

        shellr1 = lookup(parseInt(dnafixed.substring(30, 32), 16)) == className;
        shellr2 = lookup(parseInt(dnafixed.substring(32, 34), 16)) == className;

        hornr1 = lookup(parseInt(dnafixed.substring(36, 38), 16)) == className;
        hornr2 = lookup(parseInt(dnafixed.substring(38, 40), 16)) == className;

        bodyr1 = lookup(parseInt(dnafixed.substring(42, 44), 16)) == className;
        bodyr2 = lookup(parseInt(dnafixed.substring(44, 46), 16)) == className;

        mouthr1 = lookup(parseInt(dnafixed.substring(48, 50), 16)) == className;
        mouthr2 = lookup(parseInt(dnafixed.substring(50, 52), 16)) == className;

        eyer1 = lookup(parseInt(dnafixed.substring(54, 56), 16)) == className;
        eyer2 = lookup(parseInt(dnafixed.substring(56, 58), 16)) == className;

        pincerr1 = lookup(parseInt(dnafixed.substring(60, 62), 16)) == className;
        pincerr2 = lookup(parseInt(dnafixed.substring(62, 64), 16)) == className;

        return +shellr1 + +shellr2 + +hornr1 + +hornr2 + +bodyr1 + +bodyr2 + +mouthr1 + +mouthr2 + +eyer1 + +eyer2 + +pincerr1 + +pincerr2

    }

    const checkLegendary = (dna) => {
        hexString = dec2hex(dna);
        dnafixed = `0${hexString}`

        shell = parseInt(dnafixed.substring(4, 6), 16) > 0;
        horn = parseInt(dnafixed.substring(6, 8), 16) > 0;
        body = parseInt(dnafixed.substring(8, 10), 16) > 0;
        mouth = parseInt(dnafixed.substring(10, 12), 16) > 0;
        eyes = parseInt(dnafixed.substring(12, 14), 16) > 0;
        pincer = parseInt(dnafixed.substring(14, 16), 16) > 0;

        return shell || horn || body || mouth || eyes || pincer
    }

    function lookup_subclass(id) {
        subclass_map = {
            1: "Emeraldo",
            2: "Crazor",
            3: "Vocrano",
            4: "Spikey",
            5: "Frozo",
            6: "Cratos",
            7: "Rubie",
            8: "Amida",
            16: "Staro",
            17: "Craken",
            18: "Crobster",
            19: "Cralmon",
            20: "Creasure",
            21: "Crucket",
            22: "Crele",
            23: "Crotopus",
            31: "Bitcoin",
            32: "Cardano",
            33: "Near",
            34: "Ether",
            35: "Cz",
            36: "Fantom",
            37: "Avalanche",
            38: "Solana",
            46: "Cragma",
            47: "C-Rex",
            48: "Charoite",
            49: "Rocco",
            50: "Chief",
            51: "Cropion",
            52: "Crazurite",
            53: "Crava",
            61: "Twinner",
            62: "Onepunch",
            63: "Cropter",
            64: "Plasma",
            65: "Lasery",
            66: "Redeye",
            67: "Crocket",
            68: "Gear",
            76: "Skul",
            77: "Cragon",
            78: "Crombie",
            79: "Deadeye",
            80: "Cranosis",
            81: "Crailer",
            82: "Camun-Ra",
            83: "Crauldron",
            91: "Pearlio",
            92: "Lapidari",
            93: "Paraiba",
            94: "Cramethyst",
            95: "Cranet",
            96: "Croyo",
            97: "Earl Cray",
            98: "Magnifiso",
            106: "Natura",
            107: "Freshie",
            108: "Adam",
            109: "Eva",
            110: "Bulbie",
            111: "Celon",
            112: "Cranana",
            113: "Crawberry"
        }

        return subclass_map[id]
    }

    function calculate() {
        clearForm()
        let loading = document.getElementById("loading");

        let results = document.getElementById("results");
        results.style.display = "block";

        let pure = document.getElementById("pure").checked;
        let pure_eggs = document.getElementById("pure_eggs").checked;
        let legendary = document.getElementById("legendary").checked;
        let highbp = document.getElementById("highbp").checked;
        let highmp = document.getElementById("highmp").checked;
        let c56 = document.getElementById("c56").checked;

        let price = document.getElementById("price").value;
        let breed = document.getElementById("breed").value;

        localStorage.setItem("pure", pure);
        localStorage.setItem("pure_eggs", pure_eggs);
        localStorage.setItem("legendary", legendary);
        localStorage.setItem("highbp", highbp);
        localStorage.setItem("highmp", highmp);
        localStorage.setItem("c56", c56);
        localStorage.setItem("price", price);
        localStorage.setItem("breed", breed);


        const pure_crabs = []
        const eggs_list = []
        const pure_eggs_list = []
        const legendary_crabs = []
        const highbp_crabs = []
        const highmp_crabs = []
        const c56_crabs = []


        fetch(`https://api.crabada.com/public/crabada/selling?limit=2000&orderBy=price&order=asc`).then(response => response.json())
            .then(function (response) {
                crabs = response["result"]["data"];
                crabs.forEach(c => {
                    aux = {}
                    aux.price = Math.round(c.price / 1.0e18)
                    if (price && aux.price >= price) {
                        return
                    }
                    aux.crabada_id = c.crabada_id
                    aux.url = `<a href="https://marketplace.crabada.com/crabada/${c.crabada_id}" target="_blank" rel="noopener noreferrer">${c.crabada_id}</a>`

                    if (c.stage == 1) {
                        aux.breed_count = c.breed_count

                        if (breed != '' && +aux.breed_count > +breed) {
                            return
                        }

                        aux.class_name = c.class_name
                        aux.combat = c.hp + c.damage + c.armor
                        aux.mine = c.speed + c.critical
                        aux.origin = c.is_origin == 1 ? 'Yes' : 'No'
                        aux.subclass_name = lookup_subclass(c.crabada_subclass)
                        aux.pure_parts = +(c.class_id == c.horn_class) + +(c.class_id == c.shell_class) + +(c.class_id == c.body_class) + +(c.class_id == c.mouth_class) + +(c.class_id == c.eyes_class) + +(c.class_id == c.pincers_class)
                        aux.alleles = countAlleles(c.dna, c.class_name)
                        aux.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?crabid=${c.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`
                        if (aux.pure_parts == 6 && pure && aux.alleles == 12) {
                            pure_crabs.push(aux)
                        }
                        if (legendary && checkLegendary(c.dna)) {
                            legendary_crabs.push(aux)
                        }
                        if (aux.combat >= 220 && highbp) {
                            highbp_crabs.push(aux)
                        }
                        if (aux.mine >= 77 && highmp) {
                            highmp_crabs.push(aux)
                        }
                        if (c56 && (aux.pure_parts == 5 || (aux.pure_parts == 6 && aux.alleles < 12))) {
                            c56_crabs.push(aux)
                        }
                    } else {
                        if (pure_eggs) {
                            aux.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?eggid=${c.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`
                            eggs_list.push(aux)
                        }
                    }
                })
                const requests = []
                eggs_list.forEach(e => {
                    requests.push(fetch(`https://api.crabada.com/public/crabada/family/${e.crabada_id}`).then(response => response.json()))
                })
                let count = -1
                Promise.all(requests)
                    .then(function (responses) {
                        responses.forEach(r => {
                            count+=1
                            const parent1 = r["result"]["crabada_parents"][0]
                            const parent2 = r["result"]["crabada_parents"][1]
                            if(parent1.class_name != parent2.class_name){
                                return
                            }
                            if(parent1.pure_number !=6 || parent2.pure_number !=6){
                                return
                            }

                            parent1.alleles = countAlleles(parent1.dna, parent1.class_name)
                            parent2.alleles = countAlleles(parent2.dna, parent2.class_name)
                            if(parent1.alleles != 12 || parent2.alleles != 12){
                                return
                            }
                            let aux = eggs_list[count]
                            aux.class_name = parent1.class_name
                            pure_eggs_list.push(aux)
                        })


                        loading.innerHTML = "";

                        let resuls_text = document.getElementById("resuls_text");
                        resuls_text.innerHTML = ''

                        if (pure) {
                            resuls_text.innerHTML += "<h4>Pure crabs in the market: " + pure_crabs.length + "</h4>"
                            if (pure_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                pure_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table

                            } else {
                                resuls_text.innerHTML += `None found!`
                            }

                        }

                        if (pure_eggs) {
                            resuls_text.innerHTML += "<h4>Pure crabs eggs in the market: " + pure_eggs_list.length + "</h4>"
                            if (pure_eggs_list.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                    pure_eggs_list.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table

                            } else {
                                resuls_text.innerHTML += `None found!`
                            }

                        }
                        if (legendary) {
                            resuls_text.innerHTML += "<h4>Legendary crabs in the market: " + legendary_crabs.length + "</h4>"
                            if (legendary_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                legendary_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }
                        if (highbp) {
                            resuls_text.innerHTML += "<h4>High BP crabs in the market: " + highbp_crabs.length + "</h4>"
                            if (highbp_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                highbp_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }

                        if (highmp) {
                            resuls_text.innerHTML += "<h4>High MP crabs in the market: " + highmp_crabs.length + "</h4>"
                            if (highmp_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                highmp_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }
                        if (c56) {
                            resuls_text.innerHTML += "<h4>5/6 or 6/6 non-pure crabs in the market: " + c56_crabs.length + "</h4>"
                            if (c56_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                c56_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }
                    }).catch(function (error) {
                        console.log(error);
                    });
            }).catch(function (error) {
                console.log(error);
            });
    }

    function clearForm() {
        let resuls_text = document.getElementById("resuls_text");
        let results = document.getElementById("results");

        resuls_text.innerHTML = "";
        results.style.display = "none";

        let loading = document.getElementById("loading");
        loading.innerHTML = "Loading...";
    }


</script>

</html>